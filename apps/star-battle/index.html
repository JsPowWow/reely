<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>STAR DUEL</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
:root{--p1:#00ffcc;--p2:#ff4466;}
body{background:#03040e;font-family:'Orbitron',monospace;overflow:hidden;width:100vw;height:100vh;}
#c{display:block;touch-action:none;}
#hud{position:absolute;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:flex-start;padding:10px 16px;z-index:20;pointer-events:none;}
.hs{display:flex;flex-direction:column;gap:4px;min-width:140px;}
.hr{align-items:flex-end;}
.sn{font-size:11px;font-weight:700;letter-spacing:2px;}
.s1 .sn{color:var(--p1)}.s2 .sn{color:var(--p2)}
.hb{width:140px;height:9px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;}
.hbf{height:100%;border-radius:4px;transition:width .08s;}
.s1 .hbf{background:linear-gradient(90deg,#00cc99,#00ffcc);}
.s2 .hbf{background:linear-gradient(90deg,#cc2244,#ff4466);}
.eb{width:140px;height:4px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden;}
.ebf{height:100%;border-radius:2px;background:linear-gradient(90deg,#cc9900,#ffe066);transition:width .08s;}
.hc{display:flex;flex-direction:column;align-items:center;gap:2px;}
#timer{font-size:24px;font-weight:900;color:#fff;letter-spacing:4px;}
#rl{font-size:9px;color:#445;letter-spacing:3px;}
#ctrl{position:absolute;bottom:0;left:0;right:0;display:flex;justify-content:space-between;padding:10px 20px;pointer-events:none;z-index:30;}
.cs{display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none;}
.cr{align-items:flex-end;}
.jw{position:relative;pointer-events:auto;touch-action:none;user-select:none;}
.jb{width:90px;height:90px;border-radius:50%;background:rgba(255,255,255,0.03);border:1.5px solid rgba(255,255,255,0.1);}
.jk{width:36px;height:36px;border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;}
.j1 .jk{background:radial-gradient(circle,#00ffcc88,#00ffcc11);border:1.5px solid var(--p1);box-shadow:0 0 12px var(--p1);}
.j2 .jk{background:radial-gradient(circle,#ff446688,#ff446611);border:1.5px solid var(--p2);box-shadow:0 0 12px var(--p2);}
.fb{pointer-events:auto;touch-action:none;width:56px;height:56px;border-radius:50%;border:none;font-family:'Orbitron',monospace;font-size:10px;font-weight:700;cursor:pointer;transition:transform .08s;}
.fb:active{transform:scale(.88);}
.f1{background:radial-gradient(circle,#00ffcc33,transparent);border:2px solid var(--p1);color:var(--p1);}
.f2{background:radial-gradient(circle,#ff446633,transparent);border:2px solid var(--p2);color:var(--p2);}
.sp{font-size:8px;width:46px;height:46px;opacity:.85;}
.sc{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:50;background:rgba(3,4,14,.96);}
.sc.h{display:none;}
.st{font-size:clamp(28px,7vw,56px);font-weight:900;letter-spacing:8px;background:linear-gradient(135deg,var(--p1),#fff,var(--p2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px;}
.ss{font-size:11px;color:#445;letter-spacing:4px;margin-bottom:32px;}
.sg{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;margin-bottom:28px;}
.sk{width:114px;border:1.5px solid rgba(255,255,255,0.1);border-radius:10px;padding:12px 8px;cursor:pointer;text-align:center;transition:border-color .2s,transform .15s;background:rgba(255,255,255,.02);position:relative;}
.sk:hover{transform:translateY(-4px);}
.sk.p1{border-color:var(--p1);box-shadow:0 0 20px #00ffcc22;}
.sk.p2{border-color:var(--p2);box-shadow:0 0 20px #ff446622;}
.sk canvas{display:block;margin:0 auto 6px;}
.kn{font-size:10px;font-weight:700;letter-spacing:2px;color:#ccc;}
.ks{font-size:7.5px;color:#556;margin-top:3px;line-height:1.6;white-space:pre;}
.kb{position:absolute;top:-8px;right:-8px;font-size:7px;padding:2px 5px;border-radius:4px;font-weight:700;}
.kb1{background:var(--p1);color:#000;} .kb2{background:var(--p2);color:#fff;}
.sl{display:flex;gap:30px;margin-bottom:8px;font-size:9px;letter-spacing:2px;}
.sl1{color:var(--p1);} .sl2{color:var(--p2);}
.btn{padding:14px 48px;background:transparent;border:2px solid #fff;color:#fff;font-family:'Orbitron',monospace;font-size:13px;font-weight:700;letter-spacing:4px;cursor:pointer;border-radius:6px;transition:background .2s;}
.btn:hover{background:rgba(255,255,255,.08);}
.wt{font-size:clamp(20px,5vw,42px);font-weight:900;letter-spacing:6px;margin-bottom:8px;}
.wp1{color:var(--p1);text-shadow:0 0 30px var(--p1);}
.wp2{color:var(--p2);text-shadow:0 0 30px var(--p2);}
.wd{color:#fff;}
.ws{font-size:11px;color:#556;letter-spacing:3px;margin-bottom:40px;}
.kh{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:9px;color:#334;letter-spacing:2px;white-space:nowrap;}
/* keyboard reference panel */
#kref{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);display:flex;gap:28px;z-index:25;pointer-events:none;opacity:0;transition:opacity .4s;}
#kref.vis{opacity:1;}
.kpanel{display:flex;flex-direction:column;align-items:center;gap:6px;background:rgba(0,0,0,0.55);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:10px 14px;}
.kpanel-title{font-size:8px;letter-spacing:3px;font-weight:700;margin-bottom:2px;}
.kp1 .kpanel-title{color:var(--p1);}
.kp2 .kpanel-title{color:var(--p2);}
.krow{display:flex;gap:5px;justify-content:center;}
.key{display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:24px;padding:0 5px;border-radius:5px;font-size:9px;font-weight:700;letter-spacing:.5px;border-bottom:2px solid rgba(0,0,0,0.5);font-family:'Orbitron',monospace;}
.key.wide{min-width:52px;}
.key.med{min-width:38px;}
.kp1 .key{background:rgba(0,255,204,0.12);border-color:rgba(0,255,204,0.35);color:var(--p1);box-shadow:0 0 6px rgba(0,255,204,0.15);}
.kp2 .key{background:rgba(255,68,102,0.12);border-color:rgba(255,68,102,0.35);color:var(--p2);box-shadow:0 0 6px rgba(255,68,102,0.15);}
.key-label{font-size:7px;color:#445;letter-spacing:1px;margin-top:1px;}
/* hide joystick on desktop hover state for cleaner look - keep visible */

</style>
</head>
<body>

<div id="sel-sc" class="sc">
  <div class="st">STAR DUEL</div>
  <div class="ss">SELECT YOUR VESSELS</div>
  <div class="sl"><span class="sl1">P1 left-click</span><span class="sl2">right-click P2</span></div>
  <div class="sg" id="sg"></div>
  <button class="btn" id="start-btn">LAUNCH BATTLE</button>
  <div class="kh">touch joysticks on mobile &nbsp;·&nbsp; <span style="color:#446">P1: WASD + SPACE + E</span> &nbsp;|&nbsp; <span style="color:#644">P2: ARROWS + ENTER + SHIFT</span></div>
</div>

<div id="win-sc" class="sc h">
  <div class="wt" id="wt"></div>
  <div class="ws" id="ws"></div>
  <button class="btn" id="rematch-btn">REMATCH</button>
</div>

<div id="kref">
  <div class="kpanel kp1">
    <div class="kpanel-title">PLAYER 1</div>
    <div class="krow">
      <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
        <div class="krow"><span class="key">W</span></div>
        <div class="krow"><span class="key">A</span><span class="key">S</span><span class="key">D</span></div>
        <div class="key-label">↑ THRUST &nbsp; ↓ RETRO</div>
      </div>
      <div style="width:12px;"></div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
        <div class="krow"><span class="key wide">SPACE</span></div>
        <div class="krow"><span class="key wide">E</span></div>
        <div class="key-label">FIRE&nbsp;·&nbsp;SPECIAL</div>
      </div>
    </div>
  </div>
  <div class="kpanel kp2">
    <div class="kpanel-title">PLAYER 2</div>
    <div class="krow">
      <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
        <div class="krow"><span class="key">↑</span></div>
        <div class="krow"><span class="key">←</span><span class="key">↓</span><span class="key">→</span></div>
        <div class="key-label">↑ THRUST &nbsp; ↓ RETRO</div>
      </div>
      <div style="width:12px;"></div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
        <div class="krow"><span class="key wide">ENTER</span></div>
        <div class="krow"><span class="key wide">SHIFT</span></div>
        <div class="key-label">FIRE&nbsp;·&nbsp;SPECIAL</div>
      </div>
    </div>
  </div>
</div>

<canvas id="c"></canvas>

<div id="hud">
  <div class="hs s1">
    <div class="sn" id="p1n">SCOUT</div>
    <div class="hb"><div class="hbf" id="p1h" style="width:100%"></div></div>
    <div class="eb"><div class="ebf" id="p1e" style="width:100%"></div></div>
  </div>
  <div class="hc">
    <div id="rl">TIME</div>
    <div id="timer">90</div>
  </div>
  <div class="hs s2 hr">
    <div class="sn" id="p2n">TANK</div>
    <div class="hb"><div class="hbf" id="p2h" style="width:100%"></div></div>
    <div class="eb"><div class="ebf" id="p2e" style="width:100%"></div></div>
  </div>
</div>

<div id="ctrl">
  <div class="cs">
    <div class="jw j1" id="joy1"><div class="jb"><div class="jk" id="jk1"></div></div></div>
    <div style="display:flex;gap:8px">
      <button class="fb f1 sp" id="b1s">SPEC</button>
      <button class="fb f1" id="b1f">FIRE</button>
    </div>
  </div>
  <div class="cs cr">
    <div class="jw j2" id="joy2"><div class="jb"><div class="jk" id="jk2"></div></div></div>
    <div style="display:flex;gap:8px">
      <button class="fb f2" id="b2f">FIRE</button>
      <button class="fb f2 sp" id="b2s">SPEC</button>
    </div>
  </div>
</div>

<script>
var canvas = document.getElementById('c');
var ctx = canvas.getContext('2d');
var W = 0, H = 0;

// World size
var WW = 4800, WH = 4800;

// Camera
var cam = { x: WW/2, y: WH/2, zoom: 0.9 };

function wx(x) { return (x - cam.x) * cam.zoom + W/2; }
function wy(y) { return (y - cam.y) * cam.zoom + H/2; }

function resize() {
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
  buildStars();
}
window.addEventListener('resize', resize);

// ── PARALLAX STARS ──────────────────────────────
var starLayers = [
  { count:350, rMin:0.3, rMax:0.9,  alpha:0.3, parallax:0.04, stars:[] },
  { count:200, rMin:0.5, rMax:1.4,  alpha:0.5, parallax:0.12, stars:[] },
  { count:100, rMin:0.8, rMax:2.0,  alpha:0.7, parallax:0.28, stars:[] },
  { count: 35, rMin:1.2, rMax:2.6,  alpha:0.9, parallax:0.55, stars:[] }
];
var nebulas = [], dustClouds = [];

function buildStars() {
  var i, l, s, skyW = WW * 3, skyH = WH * 3;
  for (i = 0; i < starLayers.length; i++) {
    l = starLayers[i];
    l.stars = [];
    for (var j = 0; j < l.count; j++) {
      s = {
        x: (Math.random() - 0.5) * skyW,
        y: (Math.random() - 0.5) * skyH,
        r: l.rMin + Math.random() * (l.rMax - l.rMin),
        a: l.alpha * (0.5 + Math.random() * 0.5),
        tw: Math.random() * Math.PI * 2,
        p: l.parallax
      };
      l.stars.push(s);
    }
  }
  nebulas = [];
  var nc = [[18,0,70],[0,20,65],[55,0,55],[0,45,35],[75,18,0]];
  for (i = 0; i < 8; i++) {
    var col = nc[i % nc.length];
    nebulas.push({
      x: Math.random() * WW, y: Math.random() * WH,
      rx: 280 + Math.random() * 500, ry: 180 + Math.random() * 380,
      col: col, alpha: 0.07 + Math.random() * 0.1
    });
  }
  dustClouds = [];
  for (i = 0; i < 12; i++) {
    dustClouds.push({
      x: Math.random() * WW, y: Math.random() * WH,
      r: 90 + Math.random() * 180,
      alpha: 0.04 + Math.random() * 0.05,
      warm: Math.random() < 0.5
    });
  }
}

// ── AUDIO ────────────────────────────────────────
var AC = null;
function getAC() {
  if (!AC) AC = new (window.AudioContext || window.webkitAudioContext)();
  if (AC.state === 'suspended') AC.resume();
  return AC;
}
function playTone(freq, type, dur, vol, fe) {
  try {
    var ac = getAC(), o = ac.createOscillator(), g = ac.createGain();
    o.connect(g); g.connect(ac.destination);
    o.type = type;
    o.frequency.setValueAtTime(freq, ac.currentTime);
    if (fe) o.frequency.exponentialRampToValueAtTime(fe, ac.currentTime + dur);
    g.gain.setValueAtTime(vol || 0.15, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + dur);
    o.start(); o.stop(ac.currentTime + dur);
  } catch(e) {}
}
function playNoise(dur, vol, freq) {
  try {
    var ac = getAC(), sz = Math.floor(ac.sampleRate * dur);
    var buf = ac.createBuffer(1, sz, ac.sampleRate);
    var d = buf.getChannelData(0);
    for (var i = 0; i < sz; i++) d[i] = Math.random() * 2 - 1;
    var src = ac.createBufferSource(), f = ac.createBiquadFilter(), g = ac.createGain();
    src.buffer = buf; f.type = 'bandpass'; f.frequency.value = freq || 600; f.Q.value = 1.5;
    g.gain.setValueAtTime(vol || 0.15, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + dur);
    src.connect(f); f.connect(g); g.connect(ac.destination);
    src.start(); src.stop(ac.currentTime + dur);
  } catch(e) {}
}
var SFX = {
  fire:    function() { playTone(520, 'square', 0.08, 0.12, 200); },
  laser:   function() { playTone(180, 'sawtooth', 0.04, 0.05, 160); },
  hit:     function() { playNoise(0.1, 0.2, 600); playTone(120, 'sine', 0.08, 0.08, 60); },
  bump:    function() { playNoise(0.18, 0.28, 250); playTone(70, 'sine', 0.12, 0.14, 40); },
  explode: function() { playNoise(0.5, 0.35, 180); playTone(80, 'sawtooth', 0.35, 0.15, 28); },
  special: function() { playTone(300, 'sine', 0.05, 0.1, 600); playTone(600, 'sine', 0.12, 0.08, 1200); },
  shield:  function() { playTone(900, 'sine', 0.06, 0.08, 600); },
  mine:    function() { playTone(200, 'sawtooth', 0.08, 0.12, 80); },
  nova:    function() { playNoise(0.6, 0.3, 380); playTone(150, 'sine', 0.5, 0.15, 48); },
  select:  function() { playTone(440, 'sine', 0.06, 0.1, 880); },
  start:   function() {
    setTimeout(function() { playTone(300, 'sine', 0.15, 0.18); }, 0);
    setTimeout(function() { playTone(450, 'sine', 0.15, 0.18); }, 100);
    setTimeout(function() { playTone(700, 'sine', 0.15, 0.18); }, 200);
  },
  win: function() {
    var freqs = [400, 500, 600, 800];
    for (var i = 0; i < freqs.length; i++) {
      (function(f, t) { setTimeout(function() { playTone(f, 'sine', 0.25, 0.18); }, t); })(freqs[i], i * 150);
    }
  }
};

// ── SHIP DRAW FUNCTIONS ──────────────────────────
function drawScout(ctx, c, dmg) {
  ctx.shadowColor = c; ctx.shadowBlur = 16;
  var eg = ctx.createRadialGradient(-13,0,1,-13,0,9);
  eg.addColorStop(0,'rgba(255,255,255,0.53)'); eg.addColorStop(0.5,c); eg.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle = eg; ctx.beginPath(); ctx.ellipse(-13,0,9,5,0,0,Math.PI*2); ctx.fill();
  var fg = ctx.createLinearGradient(0,-8,0,8);
  fg.addColorStop(0,'rgba(255,255,255,0.22)'); fg.addColorStop(0.35,c); fg.addColorStop(1,'rgba(0,0,0,0.3)');
  ctx.fillStyle = fg;
  ctx.beginPath(); ctx.moveTo(22,0); ctx.lineTo(8,5); ctx.lineTo(-4,6); ctx.lineTo(-14,4);
  ctx.lineTo(-14,-4); ctx.lineTo(-4,-6); ctx.lineTo(8,-5); ctx.closePath(); ctx.fill();
  ctx.fillStyle = 'rgba(255,255,255,0.18)';
  ctx.beginPath(); ctx.moveTo(18,0); ctx.lineTo(6,2); ctx.lineTo(-4,2.5); ctx.lineTo(-4,-2.5); ctx.lineTo(6,-2); ctx.closePath(); ctx.fill();
  ctx.fillStyle = c + '77';
  ctx.beginPath(); ctx.moveTo(4,5); ctx.lineTo(-6,15); ctx.lineTo(-12,10); ctx.lineTo(-6,6); ctx.closePath(); ctx.fill();
  ctx.beginPath(); ctx.moveTo(4,-5); ctx.lineTo(-6,-15); ctx.lineTo(-12,-10); ctx.lineTo(-6,-6); ctx.closePath(); ctx.fill();
  var cg = ctx.createRadialGradient(12,-1,0,12,-1,5);
  cg.addColorStop(0,'#aaffff'); cg.addColorStop(0.5,'#004466'); cg.addColorStop(1,'#001122');
  ctx.fillStyle = cg; ctx.beginPath(); ctx.ellipse(12,0,5,3.5,0,0,Math.PI*2); ctx.fill();
  if (dmg > 0.25) {
    ctx.strokeStyle = 'rgba(255,90,0,' + ((dmg-0.25)*1.3) + ')'; ctx.lineWidth = 1.2;
    ctx.beginPath(); ctx.moveTo(2,3); ctx.lineTo(-4,7); ctx.stroke();
  }
  if (dmg > 0.55) {
    ctx.fillStyle = 'rgba(255,40,0,' + ((dmg-0.55)*1.5) + ')';
    ctx.beginPath(); ctx.arc(-5,4,3,0,Math.PI*2); ctx.fill();
  }
  if (dmg > 0.8) {
    ctx.fillStyle = 'rgba(255,150,0,' + ((dmg-0.8)*3) + ')';
    ctx.beginPath(); ctx.arc(0,0,5,0,Math.PI*2); ctx.fill();
  }
}

function drawTank(ctx, c, dmg) {
  ctx.shadowColor = c; ctx.shadowBlur = 22;
  var i;
  for (i = -1; i <= 1; i += 2) {
    var eg = ctx.createRadialGradient(-17,i*7,1,-17,i*7,8);
    eg.addColorStop(0,'rgba(255,255,255,0.6)'); eg.addColorStop(0.5,c); eg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle = eg; ctx.beginPath(); ctx.ellipse(-17,i*7,8,5,0,0,Math.PI*2); ctx.fill();
  }
  var hg = ctx.createLinearGradient(0,-14,0,14);
  hg.addColorStop(0,'rgba(255,255,255,0.18)'); hg.addColorStop(0.2,c); hg.addColorStop(0.8,c+'88'); hg.addColorStop(1,'rgba(0,0,0,0.6)');
  ctx.fillStyle = hg;
  ctx.beginPath(); ctx.moveTo(18,4); ctx.lineTo(8,12); ctx.lineTo(-16,12);
  ctx.lineTo(-20,8); ctx.lineTo(-20,-8); ctx.lineTo(-16,-12); ctx.lineTo(8,-12); ctx.lineTo(18,-4); ctx.closePath(); ctx.fill();
  ctx.fillStyle = 'rgba(255,255,255,0.12)';
  ctx.beginPath(); ctx.moveTo(14,4); ctx.lineTo(6,10); ctx.lineTo(-10,10); ctx.lineTo(-10,4); ctx.closePath(); ctx.fill();
  var bolts = [[-14,10],[-14,-10],[-6,12],[-6,-12],[4,12],[4,-12]];
  ctx.fillStyle = c;
  for (i = 0; i < bolts.length; i++) {
    ctx.beginPath(); ctx.arc(bolts[i][0],bolts[i][1],1.8,0,Math.PI*2); ctx.fill();
  }
  var bg = ctx.createLinearGradient(0,-3.5,0,3.5);
  bg.addColorStop(0,'rgba(255,255,255,0.28)'); bg.addColorStop(1,'rgba(0,0,0,0.55)');
  ctx.fillStyle = bg; ctx.beginPath(); ctx.rect(16,-3.5,11,7); ctx.fill();
  ctx.fillStyle = c; ctx.beginPath(); ctx.rect(27,-4,3,8); ctx.fill();
  var cg = ctx.createRadialGradient(8,-1,0,8,-1,6);
  cg.addColorStop(0,'#88ddff'); cg.addColorStop(0.4,'#002244'); cg.addColorStop(1,'#000811');
  ctx.fillStyle = cg; ctx.beginPath(); ctx.ellipse(8,0,6,5,0,0,Math.PI*2); ctx.fill();
  if (dmg > 0.2) {
    ctx.strokeStyle = 'rgba(255,60,0,' + ((dmg-0.2)*1.4) + ')'; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(-5,9); ctx.lineTo(2,5); ctx.lineTo(-1,1); ctx.stroke();
  }
  if (dmg > 0.5) {
    ctx.fillStyle = 'rgba(255,30,0,' + ((dmg-0.5)*1.5) + ')';
    ctx.beginPath(); ctx.arc(-8,9,4.5,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(-2,-8,3.5,0,Math.PI*2); ctx.fill();
  }
  if (dmg > 0.75) {
    ctx.fillStyle = 'rgba(255,130,0,' + ((dmg-0.75)*2.5) + ')';
    ctx.beginPath(); ctx.arc(3,5,3,0,Math.PI*2); ctx.fill();
  }
}

function drawSniper(ctx, c, dmg) {
  ctx.shadowColor = c; ctx.shadowBlur = 14;
  var eg = ctx.createRadialGradient(-11,0,1,-11,0,7);
  eg.addColorStop(0,'rgba(255,255,255,0.47)'); eg.addColorStop(0.5,c); eg.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle = eg; ctx.beginPath(); ctx.ellipse(-11,0,7,4,0,0,Math.PI*2); ctx.fill();
  var fg = ctx.createLinearGradient(0,-6,0,6);
  fg.addColorStop(0,'rgba(255,255,255,0.22)'); fg.addColorStop(0.3,c); fg.addColorStop(1,'rgba(0,0,0,0.3)');
  ctx.fillStyle = fg;
  ctx.beginPath(); ctx.moveTo(20,0); ctx.lineTo(6,5); ctx.lineTo(-10,5);
  ctx.lineTo(-14,3); ctx.lineTo(-14,-3); ctx.lineTo(-10,-5); ctx.lineTo(6,-5); ctx.closePath(); ctx.fill();
  ctx.fillStyle = 'rgba(255,255,255,0.22)';
  ctx.beginPath(); ctx.moveTo(16,0); ctx.lineTo(4,1.5); ctx.lineTo(-8,1.5); ctx.lineTo(-8,-1.5); ctx.lineTo(4,-1.5); ctx.closePath(); ctx.fill();
  ctx.fillStyle = 'rgba(255,255,255,0.12)'; ctx.beginPath(); ctx.rect(18,-2,16,4); ctx.fill();
  ctx.strokeStyle = c; ctx.lineWidth = 0.9; ctx.stroke();
  ctx.fillStyle = c; ctx.beginPath(); ctx.rect(33,-2.5,3,5); ctx.fill();
  ctx.fillStyle = c + '66';
  ctx.beginPath(); ctx.moveTo(-2,5); ctx.lineTo(-10,11); ctx.lineTo(-13,7); ctx.lineTo(-8,5); ctx.closePath(); ctx.fill();
  ctx.beginPath(); ctx.moveTo(-2,-5); ctx.lineTo(-10,-11); ctx.lineTo(-13,-7); ctx.lineTo(-8,-5); ctx.closePath(); ctx.fill();
  ctx.fillStyle = c + '99'; ctx.beginPath(); ctx.rect(5,-9,9,6); ctx.fill();
  ctx.fillStyle = '#001133'; ctx.beginPath(); ctx.rect(6,-8.5,7,5); ctx.fill();
  ctx.fillStyle = '#00ddff'; ctx.beginPath(); ctx.arc(9.5,-6,2,0,Math.PI*2); ctx.fill();
  var cg = ctx.createRadialGradient(10,-1,0,10,-1,4);
  cg.addColorStop(0,'#aaffee'); cg.addColorStop(0.5,'#003344'); cg.addColorStop(1,'#000d1a');
  ctx.fillStyle = cg; ctx.beginPath(); ctx.ellipse(10,0,4,3,0,0,Math.PI*2); ctx.fill();
  if (dmg > 0.3) {
    ctx.strokeStyle = 'rgba(200,100,0,' + ((dmg-0.3)*1.4) + ')'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(5,3); ctx.lineTo(0,5); ctx.stroke();
  }
  if (dmg > 0.6) {
    ctx.fillStyle = 'rgba(255,50,0,' + ((dmg-0.6)*1.6) + ')';
    ctx.beginPath(); ctx.arc(-4,4,3.5,0,Math.PI*2); ctx.fill();
  }
}

function drawBomber(ctx, c, dmg) {
  ctx.shadowColor = c; ctx.shadowBlur = 18;
  var offsets = [-8, 0, 8];
  for (var i = 0; i < offsets.length; i++) {
    var eg = ctx.createRadialGradient(-18,offsets[i],1,-18,offsets[i],6);
    eg.addColorStop(0,'rgba(255,255,255,0.53)'); eg.addColorStop(0.5,c); eg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle = eg; ctx.beginPath(); ctx.ellipse(-18,offsets[i],6,4,0,0,Math.PI*2); ctx.fill();
  }
  var hg = ctx.createLinearGradient(0,-16,0,16);
  hg.addColorStop(0,'rgba(255,255,255,0.16)'); hg.addColorStop(0.25,c); hg.addColorStop(0.75,c+'77'); hg.addColorStop(1,'rgba(0,0,0,0.5)');
  ctx.fillStyle = hg;
  ctx.beginPath(); ctx.moveTo(16,0); ctx.lineTo(6,14); ctx.lineTo(-10,16);
  ctx.lineTo(-18,10); ctx.lineTo(-18,-10); ctx.lineTo(-10,-16); ctx.lineTo(6,-14); ctx.closePath(); ctx.fill();
  ctx.fillStyle = 'rgba(255,255,255,0.1)';
  ctx.beginPath(); ctx.moveTo(12,0); ctx.lineTo(4,10); ctx.lineTo(-8,11); ctx.lineTo(-8,-11); ctx.lineTo(4,-10); ctx.closePath(); ctx.fill();
  ctx.strokeStyle = c + '44'; ctx.lineWidth = 0.9;
  var blines = [-8,-3,2,7];
  for (i = 0; i < blines.length; i++) {
    ctx.beginPath(); ctx.moveTo(blines[i],-13); ctx.lineTo(blines[i],13); ctx.stroke();
  }
  var cg = ctx.createRadialGradient(6,-2,0,6,-2,7);
  cg.addColorStop(0,'#bbeecc'); cg.addColorStop(0.4,'#004422'); cg.addColorStop(1,'#001108');
  ctx.fillStyle = cg; ctx.beginPath(); ctx.ellipse(6,0,7,5,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = '#ff3333'; ctx.beginPath(); ctx.arc(-12,14,2.2,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = '#33ff44'; ctx.beginPath(); ctx.arc(-12,-14,2.2,0,Math.PI*2); ctx.fill();
  if (dmg > 0.25) {
    ctx.strokeStyle = 'rgba(255,80,0,' + ((dmg-0.25)*1.3) + ')'; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(-5,12); ctx.lineTo(2,8); ctx.lineTo(-3,4); ctx.stroke();
  }
  if (dmg > 0.5) {
    ctx.fillStyle = 'rgba(255,40,0,' + ((dmg-0.5)*1.6) + ')';
    var bpts = [[-6,10],[0,-9],[-14,6]];
    for (i = 0; i < bpts.length; i++) {
      ctx.beginPath(); ctx.arc(bpts[i][0],bpts[i][1],3.5,0,Math.PI*2); ctx.fill();
    }
  }
}

function drawGhost(ctx, c, dmg) {
  ctx.shadowColor = c; ctx.shadowBlur = 20;
  var tg = ctx.createLinearGradient(-22,0,0,0);
  tg.addColorStop(0,'rgba(0,0,0,0)'); tg.addColorStop(1,c+'44');
  ctx.fillStyle = tg;
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-22,8); ctx.lineTo(-16,0); ctx.lineTo(-22,-8); ctx.closePath(); ctx.fill();
  var fg = ctx.createLinearGradient(0,-10,0,10);
  fg.addColorStop(0,'rgba(255,255,255,0.26)'); fg.addColorStop(0.3,c); fg.addColorStop(1,'rgba(0,0,0,0.3)');
  ctx.fillStyle = fg;
  ctx.beginPath(); ctx.moveTo(22,0); ctx.lineTo(4,5); ctx.lineTo(-8,5);
  ctx.lineTo(-12,0); ctx.lineTo(-8,-5); ctx.lineTo(4,-5); ctx.closePath(); ctx.fill();
  ctx.fillStyle = c + '66';
  ctx.beginPath(); ctx.moveTo(2,5); ctx.lineTo(-14,17); ctx.lineTo(-16,9); ctx.lineTo(-4,5); ctx.closePath(); ctx.fill();
  ctx.beginPath(); ctx.moveTo(2,-5); ctx.lineTo(-14,-17); ctx.lineTo(-16,-9); ctx.lineTo(-4,-5); ctx.closePath(); ctx.fill();
  var cg = ctx.createRadialGradient(10,0,0,10,0,5);
  cg.addColorStop(0,c+'88'); cg.addColorStop(0.6,'#001122'); cg.addColorStop(1,'#000000');
  ctx.fillStyle = cg; ctx.beginPath(); ctx.ellipse(10,0,5,3,0,0,Math.PI*2); ctx.fill();
  if (dmg > 0.3) {
    ctx.strokeStyle = 'rgba(180,100,255,' + ((dmg-0.3)*1.2) + ')'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(4,3); ctx.lineTo(-2,6); ctx.stroke();
  }
  if (dmg > 0.6) {
    ctx.fillStyle = 'rgba(180,0,255,' + ((dmg-0.6)*1.5) + ')';
    ctx.beginPath(); ctx.arc(-6,4,3.5,0,Math.PI*2); ctx.fill();
  }
}

function drawOrb(ctx, c, dmg) {
  var t = Date.now();
  ctx.shadowColor = c; ctx.shadowBlur = 24;
  var rg = ctx.createRadialGradient(0,0,10,0,0,19);
  rg.addColorStop(0,'rgba(0,0,0,0)'); rg.addColorStop(0.55,c+'33'); rg.addColorStop(0.85,c); rg.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle = rg; ctx.beginPath(); ctx.arc(0,0,19,0,Math.PI*2); ctx.fill();
  ctx.save(); ctx.rotate(t/900);
  ctx.strokeStyle = c+'66'; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.ellipse(0,0,16,6,0,0,Math.PI*2); ctx.stroke();
  ctx.restore();
  ctx.save(); ctx.rotate(-t/650);
  ctx.strokeStyle = c+'44'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.ellipse(0,0,13,8,Math.PI/4,0,Math.PI*2); ctx.stroke();
  ctx.restore();
  var sg = ctx.createRadialGradient(-5,-5,1,0,0,14);
  sg.addColorStop(0,'rgba(255,255,255,0.6)'); sg.addColorStop(0.15,c); sg.addColorStop(0.6,c+'88'); sg.addColorStop(1,'rgba(0,0,0,0.65)');
  ctx.fillStyle = sg; ctx.beginPath(); ctx.arc(0,0,14,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = 'rgba(255,255,255,0.38)'; ctx.beginPath(); ctx.ellipse(-4,-4,4.5,3,Math.PI/4,0,Math.PI*2); ctx.fill();
  var ng = ctx.createLinearGradient(10,0,20,0);
  ng.addColorStop(0,c); ng.addColorStop(1,c+'33');
  ctx.fillStyle = ng; ctx.beginPath(); ctx.rect(12,-2.5,9,5); ctx.fill();
  ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(21,0,2.8,0,Math.PI*2); ctx.fill();
  if (dmg > 0.3) {
    ctx.strokeStyle = 'rgba(255,80,0,' + ((dmg-0.3)*1.6) + ')'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(0,0,11,0.4,2.0); ctx.stroke();
  }
  if (dmg > 0.6) {
    ctx.fillStyle = 'rgba(255,40,0,' + ((dmg-0.6)*1.8) + ')';
    ctx.beginPath(); ctx.arc(5,6,4.5,0,Math.PI*2); ctx.fill();
  }
}

// ── SHIP DEFINITIONS ─────────────────────────────
var SHIPS = [
  { id:'scout',  name:'SCOUT',  stats:'SPD ████░\nHP  ██░░░\nDMG ███░░\nMASS light',
    speed:4.2, maxSpeed:6.5, hp:70,  turnSpeed:0.075, mass:1.0, radius:18,
    fireRate:180,  bulletSpeed:9,  bulletDmg:12, bulletColor:'#00ffcc',
    specialName:'DASH',   specialCooldown:5000, color:'#00ffcc',
    draw: function(ct,x,y,a,col,sc,d){ ct.save();ct.translate(x,y);ct.rotate(a);ct.scale(sc,sc);drawScout(ct,col,d);ct.restore(); }
  },
  { id:'tank',   name:'TANK',   stats:'SPD ██░░░\nHP  █████\nDMG ████░\nMASS heavy',
    speed:1.8, maxSpeed:3.5, hp:160, turnSpeed:0.04,  mass:4.0, radius:24,
    fireRate:800,  bulletSpeed:6,  bulletDmg:28, bulletColor:'#ff8800',
    specialName:'SHIELD', specialCooldown:8000, color:'#ff8800',
    draw: function(ct,x,y,a,col,sc,d){ ct.save();ct.translate(x,y);ct.rotate(a);ct.scale(sc,sc);drawTank(ct,col,d);ct.restore(); }
  },
  { id:'sniper', name:'SNIPER', stats:'SPD ███░░\nHP  ███░░\nDMG █████\nMASS mid',
    speed:2.8, maxSpeed:5.0, hp:90,  turnSpeed:0.055, mass:1.5, radius:20,
    fireRate:1200, bulletSpeed:15, bulletDmg:45, bulletColor:'#cc44ff',
    specialName:'SCOPE',  specialCooldown:6000, color:'#cc44ff',
    draw: function(ct,x,y,a,col,sc,d){ ct.save();ct.translate(x,y);ct.rotate(a);ct.scale(sc,sc);drawSniper(ct,col,d);ct.restore(); }
  },
  { id:'bomber', name:'BOMBER', stats:'SPD ██░░░\nHP  ████░\nDMG ███░░\nMASS heavy',
    speed:2.2, maxSpeed:4.0, hp:120, turnSpeed:0.05,  mass:3.0, radius:22,
    fireRate:600,  bulletSpeed:4,  bulletDmg:18, bulletColor:'#ffdd00',
    specialName:'MINE',   specialCooldown:4000, color:'#ffdd00',
    draw: function(ct,x,y,a,col,sc,d){ ct.save();ct.translate(x,y);ct.rotate(a);ct.scale(sc,sc);drawBomber(ct,col,d);ct.restore(); }
  },
  { id:'ghost',  name:'GHOST',  stats:'SPD █████\nHP  ██░░░\nDMG ███░░\nMASS feather',
    speed:5.0, maxSpeed:8.0, hp:60,  turnSpeed:0.09,  mass:0.7, radius:16,
    fireRate:350,  bulletSpeed:8,  bulletDmg:14, bulletColor:'#44ddff',
    specialName:'CLOAK',  specialCooldown:7000, color:'#44ddff',
    draw: function(ct,x,y,a,col,sc,d){ ct.save();ct.translate(x,y);ct.rotate(a);ct.scale(sc,sc);drawGhost(ct,col,d);ct.restore(); }
  },
  { id:'orb',    name:'ORB',    stats:'SPD ███░░\nHP  ███░░\nDMG █████\nMASS mid',
    speed:3.0, maxSpeed:5.0, hp:100, turnSpeed:0.12,  mass:1.8, radius:19,
    fireRate:80,   bulletSpeed:0,  bulletDmg:4,  bulletColor:'#ff2200',
    specialName:'NOVA', specialCooldown:6000, color:'#ff6600',
    isLaser:true, laserRange:90,
    draw: function(ct,x,y,a,col,sc,d){ ct.save();ct.translate(x,y);ct.rotate(a);ct.scale(sc,sc);drawOrb(ct,col,d);ct.restore(); }
  }
];

// ── SHIP SELECT UI ───────────────────────────────
var sel = [0, 1];
var sg = document.getElementById('sg');
for (var _si = 0; _si < SHIPS.length; _si++) {
  (function(i) {
    var s = SHIPS[i];
    var card = document.createElement('div'); card.className = 'sk';
    var pc = document.createElement('canvas'); pc.width = 72; pc.height = 52;
    var pctx = pc.getContext('2d');
    pctx.translate(36, 26);
    s.draw(pctx, 0, 0, 0, s.color, 1.1, 0);
    card.appendChild(pc);
    var nm = document.createElement('div'); nm.className = 'kn'; nm.textContent = s.name; card.appendChild(nm);
    var st = document.createElement('div'); st.className = 'ks'; st.textContent = s.stats; card.appendChild(st);
    card.addEventListener('click', function() { sel[0] = i; SFX.select(); updateBadges(); });
    card.addEventListener('contextmenu', function(e) { e.preventDefault(); sel[1] = i; SFX.select(); updateBadges(); });
    var tc = 0;
    card.addEventListener('touchend', function(e) { e.preventDefault(); tc++; if(tc%2===1) sel[0]=i; else sel[1]=i; SFX.select(); updateBadges(); });
    sg.appendChild(card);
  })(_si);
}

function updateBadges() {
  var cards = document.querySelectorAll('.sk');
  for (var i = 0; i < cards.length; i++) {
    cards[i].classList.remove('p1','p2');
    var old = cards[i].querySelectorAll('.kb');
    for (var j = 0; j < old.length; j++) old[j].parentNode.removeChild(old[j]);
    if (sel[0] === i) {
      cards[i].classList.add('p1');
      var b = document.createElement('span'); b.className = 'kb kb1'; b.textContent = 'P1'; cards[i].appendChild(b);
    }
    if (sel[1] === i) {
      cards[i].classList.add('p2');
      var b2 = document.createElement('span'); b2.className = 'kb kb2'; b2.textContent = 'P2'; cards[i].appendChild(b2);
    }
  }
}
updateBadges();

// ── GAME STATE ───────────────────────────────────
var game = null, bullets = [], particles = [], timerInt = null;
var asteroids = [], comets = [], debris = [];
var GAME_TIME = 120;

// ── ASTEROID ─────────────────────────────────────
function Asteroid(x, y, size) {
  this.x = x; this.y = y; this.size = size;
  this.vx = (Math.random()-0.5)*0.6;
  this.vy = (Math.random()-0.5)*0.6;
  this.rot = Math.random()*Math.PI*2;
  this.rotSpd = (Math.random()-0.5)*0.009;
  this.hp = size * 2.5; this.maxHp = this.hp;
  this.pts = [];
  var n = 7 + Math.floor(Math.random()*5);
  for (var i = 0; i < n; i++) {
    var a = (Math.PI*2/n)*i + (Math.random()-0.5)*0.5;
    var r = size*(0.65+Math.random()*0.35);
    this.pts.push([Math.cos(a)*r, Math.sin(a)*r]);
  }
  this.craters = [];
  var nc2 = 2 + Math.floor(size/18);
  for (i = 0; i < nc2; i++) {
    this.craters.push({ ox:(Math.random()-0.5)*size*0.8, oy:(Math.random()-0.5)*size*0.8, r:size*0.08+Math.random()*size*0.12 });
  }
  this.tone = Math.random()<0.25?'#8866aa':Math.random()<0.4?'#446688':'#776655';
  // procedural cracks (used when damaged)
  this.cracks = [];
  var nc3 = 4 + Math.floor(Math.random()*4);
  for (i = 0; i < nc3; i++) {
    var ca2 = Math.random()*Math.PI*2;
    var cr2 = size*(0.2+Math.random()*0.5);
    var cx2 = Math.cos(ca2+0.3)*size*0.3, cy2 = Math.sin(ca2+0.3)*size*0.3;
    this.cracks.push([
      cx2, cy2,
      Math.cos(ca2)*cr2, Math.sin(ca2)*cr2,          // main direction
      Math.cos(ca2+1.1)*cr2*0.4, Math.sin(ca2+1.1)*cr2*0.4  // branch
    ]);
  }
}
Asteroid.prototype.update = function() {
  this.x += this.vx; this.y += this.vy; this.rot += this.rotSpd;
  if (this.x < -100) this.x = WW+100; if (this.x > WW+100) this.x = -100;
  if (this.y < -100) this.y = WH+100; if (this.y > WH+100) this.y = -100;
};
Asteroid.prototype.draw = function() {
  var sx = wx(this.x), sy = wy(this.y), sc = cam.zoom;
  if (sx < -this.size*sc*2 || sx > W+this.size*sc*2 || sy < -this.size*sc*2 || sy > H+this.size*sc*2) return;
  ctx.save(); ctx.translate(sx,sy); ctx.rotate(this.rot); ctx.scale(sc,sc);
  var dmgR = 1 - this.hp/this.maxHp;
  // base fill
  var g = ctx.createRadialGradient(-this.size*0.3,-this.size*0.3,1,0,0,this.size*1.1);
  g.addColorStop(0,'#aaa090'); g.addColorStop(0.4,'#776655'); g.addColorStop(0.85,this.tone); g.addColorStop(1,'#221a12');
  ctx.fillStyle = g;
  ctx.beginPath(); ctx.moveTo(this.pts[0][0],this.pts[0][1]);
  for (var i = 1; i < this.pts.length; i++) ctx.lineTo(this.pts[i][0],this.pts[i][1]);
  ctx.closePath(); ctx.fill();
  // edge stroke
  ctx.strokeStyle = 'rgba(200,180,140,0.3)'; ctx.lineWidth = 1.2; ctx.stroke();
  // edge darkening
  var eg = ctx.createRadialGradient(0,0,this.size*0.4,0,0,this.size*1.1);
  eg.addColorStop(0,'rgba(0,0,0,0)'); eg.addColorStop(1,'rgba(0,0,0,0.5)');
  ctx.fillStyle = eg;
  ctx.beginPath(); ctx.moveTo(this.pts[0][0],this.pts[0][1]);
  for (i = 1; i < this.pts.length; i++) ctx.lineTo(this.pts[i][0],this.pts[i][1]);
  ctx.closePath(); ctx.fill();
  // craters
  for (i = 0; i < this.craters.length; i++) {
    var cr = this.craters[i];
    var cg = ctx.createRadialGradient(cr.ox-cr.r*0.2,cr.oy-cr.r*0.2,cr.r*0.1,cr.ox,cr.oy,cr.r);
    cg.addColorStop(0,'rgba(0,0,0,0.6)'); cg.addColorStop(0.7,'rgba(0,0,0,0.3)'); cg.addColorStop(1,'rgba(180,160,120,0.2)');
    ctx.fillStyle = cg; ctx.beginPath(); ctx.arc(cr.ox,cr.oy,cr.r,0,Math.PI*2); ctx.fill();
  }
  // damage: cracks stage 1
  if (dmgR > 0.25) {
    var ca = (dmgR - 0.25) * 1.1;
    ctx.strokeStyle = 'rgba(210,120,30,'+ca+')'; ctx.lineWidth = 0.9;
    for (i = 0; i < this.cracks.length; i++) {
      var ck = this.cracks[i];
      ctx.beginPath(); ctx.moveTo(ck[0],ck[1]);
      ctx.lineTo(ck[0]+ck[2],ck[1]+ck[3]); ctx.stroke();
      // branch
      ctx.beginPath(); ctx.moveTo(ck[0]+ck[2]*0.5,ck[1]+ck[3]*0.5);
      ctx.lineTo(ck[0]+ck[2]*0.5+ck[4],ck[1]+ck[3]*0.5+ck[5]); ctx.stroke();
    }
  }
  // damage: glow interior stage 2
  if (dmgR > 0.55) {
    var ga = (dmgR - 0.55) * 1.4;
    var gg = ctx.createRadialGradient(0,0,0,0,0,this.size*0.7);
    gg.addColorStop(0,'rgba(255,80,0,'+ga*0.5+')');
    gg.addColorStop(1,'rgba(255,40,0,0)');
    ctx.fillStyle = gg;
    ctx.beginPath(); ctx.moveTo(this.pts[0][0],this.pts[0][1]);
    for (i = 1; i < this.pts.length; i++) ctx.lineTo(this.pts[i][0],this.pts[i][1]);
    ctx.closePath(); ctx.fill();
  }
  // damage: bright hotspots stage 3
  if (dmgR > 0.78) {
    var ha = (dmgR - 0.78) * 3.5;
    ctx.fillStyle = 'rgba(255,180,40,'+ha+')';
    for (i = 0; i < this.craters.length; i++) {
      ctx.beginPath(); ctx.arc(this.craters[i].ox*0.6,this.craters[i].oy*0.6,this.size*0.12,0,Math.PI*2); ctx.fill();
    }
    ctx.shadowColor='#ff6600'; ctx.shadowBlur=this.size*0.4*ha;
    ctx.fillStyle='rgba(255,100,0,'+(ha*0.4)+')';
    ctx.beginPath(); ctx.moveTo(this.pts[0][0],this.pts[0][1]);
    for (i=1;i<this.pts.length;i++) ctx.lineTo(this.pts[i][0],this.pts[i][1]);
    ctx.closePath(); ctx.fill();
  }
  ctx.restore();
};

// split / damage asteroid — returns true if destroyed
function damageAsteroid(idx, dmgAmount, impactX, impactY, dvx, dvy) {
  var ast = asteroids[idx];
  ast.hp -= dmgAmount;
  // dust puff at impact
  boom(impactX, impactY, '#aa8866', 6, 2, 20, 2);
  if (ast.hp <= 0) {
    SFX.bump();
    boom(ast.x, ast.y, '#cc9955', 16, 3.5, 38, 3.5);
    boom(ast.x, ast.y, '#554433',  8, 2.0, 22, 2);
    spawnDebris(ast.x, ast.y, '#776655', 4 + Math.floor(ast.size/10));
    // split into children
    var children = ast.size > 40 ? 3 : ast.size > 22 ? 2 : 0;
    for (var k = 0; k < children; k++) {
      var angle = Math.PI*2/children*k + Math.random()*0.8;
      var spread = ast.size * 0.28;
      var child = new Asteroid(
        ast.x + Math.cos(angle)*spread,
        ast.y + Math.sin(angle)*spread,
        ast.size * (0.38 + Math.random()*0.18)
      );
      // inherit parent velocity + explosion kick
      child.vx = ast.vx + Math.cos(angle)*(1.2+Math.random()*1.5) + (dvx||0)*0.2;
      child.vy = ast.vy + Math.sin(angle)*(1.2+Math.random()*1.5) + (dvy||0)*0.2;
      child.rotSpd = (Math.random()-0.5)*0.025;
      asteroids.push(child);
    }
    asteroids.splice(idx, 1);
    return true;
  }
  return false;
}

// ── COMET ─────────────────────────────────────────
function Comet() {
  var side = Math.floor(Math.random()*4);
  if (side===0) { this.x=Math.random()*WW; this.y=-80; }
  else if (side===1) { this.x=WW+80; this.y=Math.random()*WH; }
  else if (side===2) { this.x=Math.random()*WW; this.y=WH+80; }
  else { this.x=-80; this.y=Math.random()*WH; }
  var tx = WW*0.15+Math.random()*WW*0.7;
  var ty = WH*0.15+Math.random()*WH*0.7;
  var dist = Math.sqrt((tx-this.x)*(tx-this.x)+(ty-this.y)*(ty-this.y));
  var spd = 5+Math.random()*6;  // faster: was 2.5-5.5, now 5-11
  this.vx = (tx-this.x)/dist*spd; this.vy = (ty-this.y)/dist*spd;
  this.r = 5+Math.random()*9;    // larger: was 4-11, now 5-14
  this.life = 350+Math.random()*250; this.maxLife = this.life;
  this.tail = [];
  this.tailLen = 45+Math.floor(Math.random()*35); // longer tail
  var cols = ['#aaddff','#ffffaa','#ffffff','#ffccaa','#aaffdd'];
  this.color = cols[Math.floor(Math.random()*cols.length)];
  // destructive power (used for asteroid damage)
  this.power = this.r * spd * 0.5;
}
Comet.prototype.update = function() {
  this.tail.unshift({x:this.x,y:this.y});
  if (this.tail.length > this.tailLen) this.tail.pop();
  this.x += this.vx; this.y += this.vy; this.life--;
};
Comet.prototype.draw = function() {
  if (this.tail.length < 2) return;
  ctx.save();
  for (var i = 1; i < this.tail.length; i++) {
    var t = 1 - i/this.tail.length;
    ctx.beginPath();
    ctx.moveTo(wx(this.tail[i-1].x), wy(this.tail[i-1].y));
    ctx.lineTo(wx(this.tail[i].x), wy(this.tail[i].y));
    ctx.strokeStyle = this.color; ctx.lineWidth = this.r*0.6*t*cam.zoom;
    ctx.globalAlpha = t*0.5; ctx.shadowColor = this.color; ctx.shadowBlur = 6; ctx.stroke();
  }
  ctx.globalAlpha = 1;
  var hg = ctx.createRadialGradient(wx(this.x),wy(this.y),0,wx(this.x),wy(this.y),this.r*cam.zoom*2);
  hg.addColorStop(0,'#ffffff'); hg.addColorStop(0.4,this.color); hg.addColorStop(1,'rgba(0,0,0,0)');
  ctx.shadowColor = this.color; ctx.shadowBlur = 20;
  ctx.fillStyle = hg; ctx.beginPath(); ctx.arc(wx(this.x),wy(this.y),this.r*cam.zoom*1.5,0,Math.PI*2); ctx.fill();
  ctx.restore();
};
Comet.prototype.alive = function() {
  return this.life > 0 && this.x > -200 && this.x < WW+200 && this.y > -200 && this.y < WH+200;
};

// ── DEBRIS ─────────────────────────────────────────
function Debris(x, y, color) {
  this.x = x; this.y = y;
  var a = Math.random()*Math.PI*2, spd = 0.5+Math.random()*3;
  this.vx = Math.cos(a)*spd; this.vy = Math.sin(a)*spd;
  this.rot = Math.random()*Math.PI*2; this.rotSpd = (Math.random()-0.5)*0.07;
  this.r = 3+Math.random()*9;
  this.life = 500+Math.random()*700; this.maxLife = this.life;
  this.color = color; this.heat = 1.0;
  this.pts = [];
  var n = 3+Math.floor(Math.random()*3);
  for (var i = 0; i < n; i++) {
    var ang = (Math.PI*2/n)*i+(Math.random()-0.5)*0.8;
    var r = this.r*(0.5+Math.random()*0.5);
    this.pts.push([Math.cos(ang)*r, Math.sin(ang)*r]);
  }
  this.glowing = Math.random() < 0.4;
}
Debris.prototype.update = function() {
  this.x += this.vx; this.y += this.vy;
  this.vx *= 0.999; this.vy *= 0.999;
  this.rot += this.rotSpd; this.life--;
  this.heat = Math.max(0, this.heat - 0.002);
};
Debris.prototype.draw = function() {
  var a = this.life/this.maxLife;
  ctx.save();
  ctx.translate(wx(this.x), wy(this.y)); ctx.rotate(this.rot); ctx.scale(cam.zoom,cam.zoom);
  ctx.globalAlpha = Math.min(1, a*2);
  if (this.glowing && this.heat > 0.1) {
    ctx.shadowColor = '#ff6600'; ctx.shadowBlur = 8;
  }
  var g = ctx.createRadialGradient(-this.r*0.3,-this.r*0.3,0.5,0,0,this.r);
  if (this.glowing && this.heat > 0.1) {
    g.addColorStop(0,'rgba(255,200,80,'+this.heat*0.9+')');
    g.addColorStop(0.5,this.color); g.addColorStop(1,'#111');
  } else {
    g.addColorStop(0,'rgba(180,160,140,0.8)'); g.addColorStop(1,this.color);
  }
  ctx.fillStyle = g;
  ctx.beginPath(); ctx.moveTo(this.pts[0][0],this.pts[0][1]);
  for (var i = 1; i < this.pts.length; i++) ctx.lineTo(this.pts[i][0],this.pts[i][1]);
  ctx.closePath(); ctx.fill();
  ctx.restore();
};
Debris.prototype.alive = function() { return this.life > 0; };

// ── PARTICLE ─────────────────────────────────────
function Particle(x,y,vx,vy,color,life,r) {
  this.x=x; this.y=y; this.vx=vx; this.vy=vy;
  this.color=color; this.life=life; this.maxLife=life; this.r=r;
}

// ── BULLET ───────────────────────────────────────
function Bullet(x,y,vx,vy,dmg,color,owner,isMine) {
  this.x=x; this.y=y; this.vx=vx; this.vy=vy;
  this.dmg=dmg; this.color=color; this.owner=owner; this.isMine=!!isMine;
  this.life=isMine?300:180; this.maxLife=this.life; this.r=isMine?8:3;
}

// ── SHIP ─────────────────────────────────────────
function Ship(def,x,y,angle,pi) {
  this.def=def; this.x=x; this.y=y; this.angle=angle;
  this.vx=0; this.vy=0; this.hp=def.hp; this.maxHp=def.hp;
  this.energy=100; this.maxEnergy=100;
  this.lastFire=0; this.lastSpecial=0;
  this.playerIdx=pi;
  this.color=pi===0?'#00ffcc':'#ff4466';
  this.specialActive=false; this.specialTimer=0;
  this.alpha=1; this.shieldHp=0;
  this.hitFlash=0; this.laserTarget=null; this.collideFlash=0;
}
Ship.prototype.alive = function() { return this.hp > 0; };
Ship.prototype.dmg  = function() { return Math.max(0,Math.min(1,1-this.hp/this.maxHp)); };

// ── HELPERS ──────────────────────────────────────
function boom(x,y,color,n,spd,life,sz) {
  for (var i=0;i<n;i++) {
    var a=Math.random()*Math.PI*2, s=Math.random()*spd+spd*0.2;
    particles.push(new Particle(x,y,Math.cos(a)*s,Math.sin(a)*s,color,life*(0.6+Math.random()*0.8),Math.random()*sz+0.5));
  }
}
function sparks(x,y) {
  for (var i=0;i<8;i++) {
    var a=Math.random()*Math.PI*2, s=Math.random()*6+2;
    particles.push(new Particle(x,y,Math.cos(a)*s,Math.sin(a)*s,'#ffffff',8+Math.random()*8,Math.random()*1.5+0.5));
  }
  boom(x,y,'#ff9900',6,3,22,2.5);
}
function spawnDebris(x,y,color,n) {
  for (var i=0;i<n;i++) debris.push(new Debris(x,y,color));
}

// ── ASTEROIDS GEN ────────────────────────────────
function genAsteroids() {
  asteroids = [];
  var i, j, x, y, d1, d2;
  for (i = 0; i < 6; i++) {
    var cx = 200+Math.random()*(WW-400), cy = 200+Math.random()*(WH-400);
    var n = 3+Math.floor(Math.random()*5);
    for (j = 0; j < n; j++) {
      x = cx+(Math.random()-0.5)*350; y = cy+(Math.random()-0.5)*350;
      d1 = Math.sqrt((x-WW*0.25)*(x-WW*0.25)+(y-WH*0.5)*(y-WH*0.5));
      d2 = Math.sqrt((x-WW*0.75)*(x-WW*0.75)+(y-WH*0.5)*(y-WH*0.5));
      if (d1<200||d2<200) continue;
      asteroids.push(new Asteroid(x,y,20+Math.random()*55));
    }
  }
  for (i = 0; i < 18; i++) {
    x = Math.random()*WW; y = Math.random()*WH;
    d1 = Math.sqrt((x-WW*0.25)*(x-WW*0.25)+(y-WH*0.5)*(y-WH*0.5));
    d2 = Math.sqrt((x-WW*0.75)*(x-WW*0.75)+(y-WH*0.5)*(y-WH*0.5));
    if (d1<220||d2<220) continue;
    asteroids.push(new Asteroid(x,y,15+Math.random()*38));
  }
}

function initGame() {
  bullets=[]; particles=[]; debris=[]; comets=[];
  genAsteroids();
  var s0=SHIPS[sel[0]], s1=SHIPS[sel[1]];
  game = {
    p: [new Ship(s0,WW*0.25,WH*0.5,0,0), new Ship(s1,WW*0.75,WH*0.5,Math.PI,1)],
    time: GAME_TIME, over: false
  };
  cam.x=WW/2; cam.y=WH/2; cam.zoom=0.9;
  document.getElementById('p1n').textContent=s0.name;
  document.getElementById('p2n').textContent=s1.name;
  updateHUD();
}

// ── INPUT ────────────────────────────────────────
var keys = {};  // tracks e.key (arrows, Enter, Shift)
var codes = {}; // tracks e.code (layout-independent: KeyW, KeyA etc.)

// Use capture:true so we intercept keys BEFORE any focused button/element
document.addEventListener('keydown', function(e) {
  keys[e.key]  = true;
  codes[e.code] = true;
  // Prevent browser defaults for game keys (scrolling, button clicks, etc.)
  if (GAME_CODES[e.code] || GAME_KEYS[e.key]) e.preventDefault();
}, true);

document.addEventListener('keyup', function(e) {
  keys[e.key]  = false;
  codes[e.code] = false;
}, true);

// Clear all keys if window loses focus (prevents stuck keys)
window.addEventListener('blur', function() { keys = {}; codes = {}; });

// Layout-independent codes for P1 (works on any keyboard language)
var GAME_CODES = {
  'KeyW':1,'KeyA':1,'KeyS':1,'KeyD':1,
  'Space':1,'KeyE':1,'KeyF':1,'KeyG':1
};
// Key names for P2 (arrows/Enter/Shift don't change with layout)
var GAME_KEYS = {
  'ArrowUp':1,'ArrowDown':1,'ArrowLeft':1,'ArrowRight':1,
  'Enter':1,'Shift':1,',':1,'.':1
};
var joy = [{dx:0,dy:0,active:false,id:-1},{dx:0,dy:0,active:false,id:-1}];
var btnFire=[false,false], btnSpec=[false,false];

function setupJoy(elId,knobId,ji) {
  var el=document.getElementById(elId), kn=document.getElementById(knobId), R=45;
  function gp(t) { var r=el.getBoundingClientRect(); return {x:t.clientX-r.left-r.width/2,y:t.clientY-r.top-r.height/2}; }
  el.addEventListener('touchstart',function(e){ e.preventDefault(); var t=e.changedTouches[0]; joy[ji].id=t.identifier; joy[ji].active=true; },{passive:false});
  el.addEventListener('touchmove',function(e){
    e.preventDefault();
    for (var k=0;k<e.changedTouches.length;k++) {
      var t=e.changedTouches[k];
      if(t.identifier===joy[ji].id){
        var p=gp(t), d=Math.sqrt(p.x*p.x+p.y*p.y), c=d>R?R/d:1;
        joy[ji].dx=p.x*c/R; joy[ji].dy=p.y*c/R;
        kn.style.transform='translate(calc(-50% + '+(p.x*c)+'px),calc(-50% + '+(p.y*c)+'px))';
      }
    }
  },{passive:false});
  function end(e) {
    for (var k=0;k<e.changedTouches.length;k++) {
      if(e.changedTouches[k].identifier===joy[ji].id){
        joy[ji].dx=0; joy[ji].dy=0; joy[ji].active=false;
        kn.style.transform='translate(-50%,-50%)';
      }
    }
  }
  el.addEventListener('touchend',end,{passive:false});
  el.addEventListener('touchcancel',end,{passive:false});
}
setupJoy('joy1','jk1',0); setupJoy('joy2','jk2',1);

function setupBtn(id,pi,type) {
  var el=document.getElementById(id);
  el.addEventListener('touchstart',function(e){e.preventDefault();if(type==='f')btnFire[pi]=true;else btnSpec[pi]=true;},{passive:false});
  el.addEventListener('touchend',  function(e){e.preventDefault();if(type==='f')btnFire[pi]=false;else btnSpec[pi]=false;},{passive:false});
  el.addEventListener('mousedown',function(){ if(type==='f')btnFire[pi]=true;else btnSpec[pi]=true; });
  el.addEventListener('mouseup',  function(){ if(type==='f')btnFire[pi]=false;else btnSpec[pi]=false; });
}
setupBtn('b1f',0,'f'); setupBtn('b1s',0,'s');
setupBtn('b2f',1,'f'); setupBtn('b2s',1,'s');

// ── COLLISION PHYSICS ─────────────────────────────
function checkShipCollision() {
  var a=game.p[0], b=game.p[1];
  if (!a.alive()||!b.alive()) return;
  var dx=b.x-a.x, dy=b.y-a.y, dist=Math.sqrt(dx*dx+dy*dy);
  var minD=a.def.radius+b.def.radius;
  if (dist>=minD||dist<0.01) return;
  var ov=minD-dist, nx=dx/dist, ny=dy/dist, tm=a.def.mass+b.def.mass;
  a.x-=nx*ov*(b.def.mass/tm); a.y-=ny*ov*(b.def.mass/tm);
  b.x+=nx*ov*(a.def.mass/tm); b.y+=ny*ov*(a.def.mass/tm);
  var dvn=(b.vx-a.vx)*nx+(b.vy-a.vy)*ny;
  if (dvn>0) return;
  var e=0.55, j2=-(1+e)*dvn/(1/a.def.mass+1/b.def.mass);
  a.vx-=(j2*nx)/a.def.mass; a.vy-=(j2*ny)/a.def.mass;
  b.vx+=(j2*nx)/b.def.mass; b.vy+=(j2*ny)/b.def.mass;
  var imp=Math.abs(dvn);
  if (imp>0.7) {
    a.hp-=imp*b.def.mass*0.28; b.hp-=imp*a.def.mass*0.28;
    a.hitFlash=8; b.hitFlash=8; a.collideFlash=10; b.collideFlash=10;
    SFX.bump();
    var mx=(a.x+b.x)/2, my=(a.y+b.y)/2;
    sparks(mx,my);
  }
}

// ── FIRE WEAPON ──────────────────────────────────
function fireWeapon(ship) {
  var now=Date.now();
  if (now-ship.lastFire<ship.def.fireRate) return;
  if (ship.energy<5) return;
  ship.lastFire=now; ship.energy-=5;
  if (ship.def.isLaser) {
    var en=game.p[ship.playerIdx===0?1:0];
    if (en && en.alive()) {
      var dx=en.x-ship.x, dy=en.y-ship.y, dist=Math.sqrt(dx*dx+dy*dy);
      if (dist<ship.def.laserRange) {
        var dmg=ship.def.bulletDmg;
        if (en.shieldHp>0){en.shieldHp-=dmg;dmg=0;if(en.shieldHp<0){dmg=-en.shieldHp;en.shieldHp=0;}}
        en.hp-=dmg; en.hitFlash=3;
        if(dmg>0)SFX.laser(); else SFX.shield();
        ship.laserTarget={x:en.x,y:en.y};
        var mx=ship.x+dx*0.65, my2=ship.y+dy*0.65;
        if(Math.random()<0.5) particles.push(new Particle(mx,my2,(Math.random()-0.5)*3,(Math.random()-0.5)*3,'#ff6600',12,2.5));
      } else ship.laserTarget=null;
    }
    return;
  }
  SFX.fire();
  bullets.push(new Bullet(
    ship.x+Math.cos(ship.angle)*24, ship.y+Math.sin(ship.angle)*24,
    Math.cos(ship.angle)*ship.def.bulletSpeed+ship.vx*0.3,
    Math.sin(ship.angle)*ship.def.bulletSpeed+ship.vy*0.3,
    ship.def.bulletDmg, ship.def.bulletColor, ship.playerIdx, false
  ));
  ship.vx-=Math.cos(ship.angle)*0.22; ship.vy-=Math.sin(ship.angle)*0.22;
}

function activateSpecial(ship) {
  var now=Date.now();
  if (now-ship.lastSpecial<ship.def.specialCooldown) return;
  if (ship.energy<30) return;
  ship.lastSpecial=now; ship.energy-=30;
  var id=ship.def.id;
  if (id==='scout') {
    ship.vx+=Math.cos(ship.angle)*9; ship.vy+=Math.sin(ship.angle)*9;
    SFX.special(); boom(ship.x,ship.y,ship.color,22,3,32,2.5);
  } else if (id==='tank') {
    ship.shieldHp=60; ship.specialActive=true; ship.specialTimer=3000; SFX.shield();
  } else if (id==='sniper') {
    SFX.special();
    var sb=new Bullet(ship.x+Math.cos(ship.angle)*30,ship.y+Math.sin(ship.angle)*30,Math.cos(ship.angle)*20+ship.vx,Math.sin(ship.angle)*20+ship.vy,80,ship.def.bulletColor,ship.playerIdx,false);
    sb.r=6; bullets.push(sb);
  } else if (id==='bomber') {
    SFX.mine(); bullets.push(new Bullet(ship.x,ship.y,0,0,40,'#ffdd00',ship.playerIdx,true));
  } else if (id==='ghost') {
    ship.alpha=0.18; ship.specialActive=true; ship.specialTimer=3000; SFX.special();
  } else if (id==='orb') {
    SFX.nova();
    for (var k=0;k<12;k++) {
      var a2=(Math.PI*2/12)*k;
      var nb2=new Bullet(ship.x,ship.y,Math.cos(a2)*7,Math.sin(a2)*7,20,'#ff6600',ship.playerIdx,false);
      nb2.r=4; nb2.life=45; nb2.maxLife=45; bullets.push(nb2);
    }
    boom(ship.x,ship.y,'#ff4400',28,5,42,3.5);
  }
}

// ── UPDATE SHIP ───────────────────────────────────
function updateShip(ship, pi) {
  if (!ship.alive()) return;
  var thrust=false, reverse=false, left=false, right=false, fire=false, special=false;
  if (pi===0) {
    thrust =!!codes['KeyW'];
    reverse=!!codes['KeyS'];
    left   =!!codes['KeyA'];
    right  =!!codes['KeyD'];
    fire   =!!(codes['Space']||codes['KeyF']||btnFire[0]);
    special=!!(codes['KeyE'] ||codes['KeyG']||btnSpec[0]);
    if (joy[0].active) {
      var jx=joy[0].dx,jy=joy[0].dy,jl=Math.sqrt(jx*jx+jy*jy);
      if (jl>0.12) {
        var ja=Math.atan2(jy,jx);
        var df=ja-ship.angle;
        while(df>Math.PI)df-=Math.PI*2; while(df<-Math.PI)df+=Math.PI*2;
        ship.angle+=df*0.15;
        if(jl>0.3) thrust=true;
      }
    }
  } else {
    thrust =!!keys['ArrowUp'];
    reverse=!!keys['ArrowDown'];
    left   =!!keys['ArrowLeft'];
    right  =!!keys['ArrowRight'];
    fire   =!!(keys['Enter']||keys[',']||btnFire[1]);
    special=!!(keys['Shift']||keys['.']||btnSpec[1]);
    if (joy[1].active) {
      var jx2=joy[1].dx,jy2=joy[1].dy,jl2=Math.sqrt(jx2*jx2+jy2*jy2);
      if (jl2>0.12) {
        var ja2=Math.atan2(jy2,jx2);
        var df2=ja2-ship.angle;
        while(df2>Math.PI)df2-=Math.PI*2; while(df2<-Math.PI)df2+=Math.PI*2;
        ship.angle+=df2*0.15;
        if(jl2>0.3) thrust=true;
      }
    }
  }
  if (left)  ship.angle-=ship.def.turnSpeed;
  if (right) ship.angle+=ship.def.turnSpeed;
  if (thrust) {
    ship.vx+=Math.cos(ship.angle)*ship.def.speed*0.06;
    ship.vy+=Math.sin(ship.angle)*ship.def.speed*0.06;
    if (Math.random()<0.38) {
      var pa=ship.angle+Math.PI+(Math.random()-0.5)*0.6;
      particles.push(new Particle(ship.x-Math.cos(ship.angle)*16,ship.y-Math.sin(ship.angle)*16,Math.cos(pa)*2.5+ship.vx*0.08,Math.sin(pa)*2.5+ship.vy*0.08,ship.color+'bb',20,2));
    }
  }
  if (reverse) {
    // retro-thrust: slower than forward (60%), with small front exhaust puff
    ship.vx-=Math.cos(ship.angle)*ship.def.speed*0.036;
    ship.vy-=Math.sin(ship.angle)*ship.def.speed*0.036;
    if (Math.random()<0.25) {
      var pf=ship.angle+(Math.random()-0.5)*0.4;
      particles.push(new Particle(ship.x+Math.cos(ship.angle)*14,ship.y+Math.sin(ship.angle)*14,Math.cos(pf)*1.5+ship.vx*0.05,Math.sin(pf)*1.5+ship.vy*0.05,ship.color+'66',14,1.5));
    }
  }
  ship.vx*=0.978; ship.vy*=0.978;
  var spd=Math.sqrt(ship.vx*ship.vx+ship.vy*ship.vy);
  if (spd>ship.def.maxSpeed) { ship.vx=ship.vx/spd*ship.def.maxSpeed; ship.vy=ship.vy/spd*ship.def.maxSpeed; }
  ship.x+=ship.vx; ship.y+=ship.vy;
  if(ship.x<-40)ship.x=WW+40; if(ship.x>WW+40)ship.x=-40;
  if(ship.y<-40)ship.y=WH+40; if(ship.y>WH+40)ship.y=-40;
  if (fire)    fireWeapon(ship);
  if (special) activateSpecial(ship);
  ship.energy=Math.min(ship.maxEnergy,ship.energy+0.08);
  if (ship.specialActive) { ship.specialTimer-=16; if(ship.specialTimer<=0){ship.specialActive=false;ship.alpha=1;ship.shieldHp=0;} }
  if (ship.hitFlash>0)    ship.hitFlash--;
  if (ship.collideFlash>0) ship.collideFlash--;
  if (ship.dmg()>0.45&&Math.random()<ship.dmg()*0.12) {
    particles.push(new Particle(ship.x+(Math.random()-0.5)*16,ship.y+(Math.random()-0.5)*16,(Math.random()-0.5)*0.4,(Math.random()-0.5)*0.4,'#444444',50,4+Math.random()*3));
  }
  if (ship.dmg()>0.75&&Math.random()<0.06) {
    particles.push(new Particle(ship.x+(Math.random()-0.5)*ship.def.radius,ship.y+(Math.random()-0.5)*ship.def.radius,(Math.random()-0.5)*1.5,(Math.random()-0.5)*1.5,'#ff5500',22,3));
  }
}

// ── UPDATE BULLETS ────────────────────────────────
function updateBullets() {
  var i, ship, b, dx, dy, dist, dmg;
  for (i=bullets.length-1;i>=0;i--) {
    b=bullets[i];
    if (!b.isMine) { b.x+=b.vx; b.y+=b.vy; }
    b.life--;
    if (!b.isMine) {
      if(b.x<-28)b.x=WW+28; if(b.x>WW+28)b.x=-28;
      if(b.y<-28)b.y=WH+28; if(b.y>WH+28)b.y=-28;
    }
    if (b.life<=0) { bullets.splice(i,1); continue; }
    var hit=false;
    for (var pi=0;pi<game.p.length;pi++) {
      ship=game.p[pi];
      if (ship.playerIdx===b.owner||!ship.alive()) continue;
      if (ship.def.id==='ghost'&&ship.specialActive) continue;
      dx=ship.x-b.x; dy=ship.y-b.y; dist=Math.sqrt(dx*dx+dy*dy);
      if (dist<ship.def.radius+b.r-4) {
        dmg=b.dmg;
        if(ship.shieldHp>0){ship.shieldHp-=dmg;dmg=0;if(ship.shieldHp<0){dmg=-ship.shieldHp;ship.shieldHp=0;}}
        ship.hp-=dmg; ship.hitFlash=6;
        if(dmg>0)SFX.hit();
        if(ship.hp<=0)SFX.explode();
        boom(b.x,b.y,b.color,b.isMine?26:10,b.isMine?4:3,b.isMine?45:28,b.isMine?3.5:2.5);
        sparks(b.x,b.y);
        bullets.splice(i,1); hit=true; break;
      }
    }
    if (hit) continue;
    // bullet vs asteroid
    for (var ai=asteroids.length-1;ai>=0;ai--) {
      var ast=asteroids[ai];
      dx=b.x-ast.x; dy=b.y-ast.y; dist=Math.sqrt(dx*dx+dy*dy);
      if (dist<ast.size+b.r) {
        damageAsteroid(ai, b.dmg * 0.55, b.x, b.y, b.vx, b.vy);
        bullets.splice(i,1);
        hit=true; break;
      }
    }
  }
}

// ── UPDATE PARTICLES ──────────────────────────────
function updateParticles() {
  for (var i=particles.length-1;i>=0;i--) {
    var p=particles[i];
    p.x+=p.vx; p.y+=p.vy; p.vx*=0.93; p.vy*=0.93;
    p.life--; if(p.life<=0) particles.splice(i,1);
  }
}

// ── UPDATE WORLD OBJECTS ──────────────────────────
function updateWorld() {
  var i, ast, c2, dx, dy, dist, minD, dvn, imp, dmg;
  // asteroids vs ships + asteroids vs asteroids
  for (i=asteroids.length-1;i>=0;i--) {
    if (i>=asteroids.length) continue;
    ast=asteroids[i]; ast.update();

    // asteroid vs ships
    for (var pi=0;pi<game.p.length;pi++) {
      var ship=game.p[pi]; if(!ship.alive()) continue;
      dx=ship.x-ast.x; dy=ship.y-ast.y; dist=Math.sqrt(dx*dx+dy*dy);
      minD=ship.def.radius+ast.size;
      if (dist<minD&&dist>0.1) {
        var nx2=dx/dist, ny2=dy/dist, ov=minD-dist;
        // push ship out proportionally
        ship.x+=nx2*ov*0.8; ship.y+=ny2*ov*0.8;
        ast.x-=nx2*ov*0.2; ast.y-=ny2*ov*0.2;
        dvn=(ship.vx-ast.vx)*nx2+(ship.vy-ast.vy)*ny2;
        if (dvn<0) {
          imp=Math.abs(dvn);
          var e2=0.45, massA=ship.def.mass, massB=Math.max(1,ast.size*0.08);
          var jj=-(1+e2)*dvn/(1/massA+1/massB);
          ship.vx+=(jj*nx2)/massA; ship.vy+=(jj*ny2)/massA;
          ast.vx-=(jj*nx2)/massB; ast.vy-=(jj*ny2)/massB;
          // clamp asteroid speed
          var aspd=Math.sqrt(ast.vx*ast.vx+ast.vy*ast.vy);
          if(aspd>4){ast.vx=ast.vx/aspd*4;ast.vy=ast.vy/aspd*4;}
          // ship damage
          dmg=imp*ast.size*0.10;
          if (dmg>0.8) {
            ship.hp-=dmg; ship.hitFlash=6; ship.collideFlash=8;
            SFX.bump();
            var mx2=(ship.x+ast.x)/2, my2=(ship.y+ast.y)/2;
            sparks(mx2,my2);
          }
          // asteroid damage from collision with ship
          var astDmg = imp * massA * 1.8;
          if (astDmg > 0.5 && i<asteroids.length && asteroids[i]===ast) {
            damageAsteroid(i, astDmg, (ship.x+ast.x)/2, (ship.y+ast.y)/2, -ship.vx, -ship.vy);
          }
        }
      }
    }

    // asteroid vs asteroid
    for (var j=i-1;j>=0;j--) {
      if (i>=asteroids.length||j>=asteroids.length) break;
      var ast2=asteroids[j];
      dx=ast2.x-ast.x; dy=ast2.y-ast.y; dist=Math.sqrt(dx*dx+dy*dy);
      minD=ast.size+ast2.size;
      if (dist<minD&&dist>0.1) {
        var nx3=dx/dist, ny3=dy/dist, ov3=minD-dist;
        var m1=Math.max(1,ast.size*0.08), m2=Math.max(1,ast2.size*0.08), mt=m1+m2;
        ast.x-=nx3*ov3*(m2/mt); ast.y-=ny3*ov3*(m2/mt);
        ast2.x+=nx3*ov3*(m1/mt); ast2.y+=ny3*ov3*(m1/mt);
        dvn=(ast2.vx-ast.vx)*nx3+(ast2.vy-ast.vy)*ny3;
        if (dvn<0) {
          imp=Math.abs(dvn);
          var e3=0.6, jj3=-(1+e3)*dvn/(1/m1+1/m2);
          ast.vx-=(jj3*nx3)/m1; ast.vy-=(jj3*ny3)/m1;
          ast2.vx+=(jj3*nx3)/m2; ast2.vy+=(jj3*ny3)/m2;
          // clamp
          var sp1=Math.sqrt(ast.vx*ast.vx+ast.vy*ast.vy);
          var sp2=Math.sqrt(ast2.vx*ast2.vx+ast2.vy*ast2.vy);
          if(sp1>5){ast.vx=ast.vx/sp1*5;ast.vy=ast.vy/sp1*5;}
          if(sp2>5){ast2.vx=ast2.vx/sp2*5;ast2.vy=ast2.vy/sp2*5;}
          // mutual damage proportional to impact speed × other mass
          var dmg1=imp*m2*2.2, dmg2=imp*m1*2.2;
          var mx3=(ast.x+ast2.x)/2, my3=(ast.y+ast2.y)/2;
          if (imp>0.4) {
            boom(mx3,my3,'#aa8844',6,2,22,2);
            if (imp>1.2) sparks(mx3,my3);
          }
          // damage asteroid i (larger impact from j)
          if (dmg1>0.8 && i<asteroids.length && asteroids[i]===ast) {
            if (damageAsteroid(i, dmg1, mx3, my3, 0, 0)) { i--; break; }
          }
          // damage asteroid j
          if (dmg2>0.8 && j<asteroids.length && asteroids[j]===ast2) {
            if (damageAsteroid(j, dmg2, mx3, my3, 0, 0)) { break; }
          }
        }
      }
    }
  }
  // comets
  for (i=comets.length-1;i>=0;i--) {
    c2=comets[i]; c2.update();
    var cometDead = false;

    // comet vs ships
    for (var pi2=0;pi2<game.p.length;pi2++) {
      var sh2=game.p[pi2]; if(!sh2.alive()) continue;
      dx=sh2.x-c2.x; dy=sh2.y-c2.y; dist=Math.sqrt(dx*dx+dy*dy);
      if (dist<sh2.def.radius+c2.r*2.5) {
        sh2.hp-=Math.sqrt(c2.vx*c2.vx+c2.vy*c2.vy)*3.5;
        sh2.vx+=c2.vx*0.5; sh2.vy+=c2.vy*0.5; sh2.hitFlash=10;
        boom(c2.x,c2.y,c2.color,18,5,35,3.5); SFX.bump();
        comets.splice(i,1); cometDead=true; break;
      }
    }
    if (cometDead) continue;

    // comet vs asteroids
    var hitAst = false;
    for (var ai2=asteroids.length-1;ai2>=0;ai2--) {
      var ast3=asteroids[ai2];
      dx=ast3.x-c2.x; dy=ast3.y-c2.y; dist=Math.sqrt(dx*dx+dy*dy);
      if (dist < ast3.size + c2.r*1.5) {
        // big damage — proportional to comet power
        var cometDmg = (c2.power||30) * 1.8;
        boom(c2.x,c2.y,c2.color,20,5,40,3.5);
        boom(c2.x,c2.y,'#aa8844',10,3,25,2.5);
        SFX.bump();
        // kick asteroid in comet direction
        ast3.vx += c2.vx * 0.25; ast3.vy += c2.vy * 0.25;
        var cAspd = Math.sqrt(ast3.vx*ast3.vx+ast3.vy*ast3.vy);
        if(cAspd>6){ast3.vx=ast3.vx/cAspd*6;ast3.vy=ast3.vy/cAspd*6;}
        if (ai2 < asteroids.length && asteroids[ai2]===ast3) {
          damageAsteroid(ai2, cometDmg, c2.x, c2.y, c2.vx, c2.vy);
        }
        comets.splice(i,1); hitAst=true; break;
      }
    }
    if (hitAst) continue;

    if (i<comets.length && !comets[i].alive()) comets.splice(i,1);
  }
  // debris
  for (i=debris.length-1;i>=0;i--) {
    debris[i].update(); if(!debris[i].alive()) debris.splice(i,1);
  }
  // comet spawn: more frequent, higher cap
  if (Math.random()<0.007 && comets.length<12) comets.push(new Comet());
  // occasional burst of 2
  if (Math.random()<0.0015 && comets.length<10) { comets.push(new Comet()); comets.push(new Comet()); }
}

// ── UPDATE CAMERA ─────────────────────────────────
function updateCamera() {
  var alive=[], i;
  for (i=0;i<game.p.length;i++) { if(game.p[i].alive()) alive.push(game.p[i]); }
  if (!alive.length) return;
  var mx=0,my=0;
  for (i=0;i<alive.length;i++){mx+=alive[i].x;my+=alive[i].y;}
  mx/=alive.length; my/=alive.length;
  cam.x+=(mx-cam.x)*0.06; cam.y+=(my-cam.y)*0.06;
  if (alive.length===2) {
    var ddx=alive[0].x-alive[1].x, ddy=alive[0].y-alive[1].y;
    var dd=Math.sqrt(ddx*ddx+ddy*ddy);
    var tz=Math.max(0.38,Math.min(1.1,Math.min(W,H)*0.6/Math.max(dd,200)));
    cam.zoom+=(tz-cam.zoom)*0.04;
  }
}

// ── HUD ───────────────────────────────────────────
function updateHUD() {
  if (!game) return;
  var p0=game.p[0],p1=game.p[1];
  document.getElementById('p1h').style.width=Math.max(0,p0.hp/p0.maxHp*100)+'%';
  document.getElementById('p2h').style.width=Math.max(0,p1.hp/p1.maxHp*100)+'%';
  document.getElementById('p1e').style.width=(p0.energy/p0.maxEnergy*100)+'%';
  document.getElementById('p2e').style.width=(p1.energy/p1.maxEnergy*100)+'%';
}

// ── WIN CHECK ────────────────────────────────────
function checkWin() {
  var p0=game.p[0],p1=game.p[1],p0d=p0.hp<=0,p1d=p1.hp<=0;
  if (p0d||p1d||game.time<=0) {
    game.over=true; clearInterval(timerInt);
    var i;
    for (i=0;i<game.p.length;i++) {
      var s=game.p[i];
      if (s.hp<=0) {
        spawnDebris(s.x,s.y,s.color,20);
        spawnDebris(s.x,s.y,'#666666',12);
        boom(s.x,s.y,s.color,30,6,65,4.5);
        boom(s.x,s.y,'#ff8800',20,4,40,3.5);
      }
    }
    var wt,ws,wc;
    if (p0d&&p1d){wt='DRAW';ws='MUTUAL ANNIHILATION';wc='wd';}
    else if (p1d){wt='PLAYER 1 WINS';ws=SHIPS[sel[0]].name+' VICTORIOUS';wc='wp1';}
    else if (p0d){wt='PLAYER 2 WINS';ws=SHIPS[sel[1]].name+' VICTORIOUS';wc='wp2';}
    else {
      var r0=p0.hp/p0.maxHp,r1=p1.hp/p1.maxHp;
      if(r0>r1){wt='PLAYER 1 WINS';ws='BY ENDURANCE';wc='wp1';}
      else if(r1>r0){wt='PLAYER 2 WINS';ws='BY ENDURANCE';wc='wp2';}
      else{wt='DRAW';ws='EQUAL FORTITUDE';wc='wd';}
    }
    document.getElementById('wt').textContent=wt;
    document.getElementById('wt').className='wt '+wc;
    document.getElementById('ws').textContent=ws;
    setTimeout(function(){ SFX.win(); document.getElementById('win-sc').classList.remove('h'); }, 1400);
  }
}

// ── DRAW ─────────────────────────────────────────
function drawBackground() {
  ctx.fillStyle='#030410'; ctx.fillRect(0,0,W,H);
  var i, nb, p, sx, sy, rg;
  // nebulas
  for (i=0;i<nebulas.length;i++) {
    nb=nebulas[i]; p=0.02;
    sx=wx(nb.x*p+(1-p)*WW/2); sy=wy(nb.y*p+(1-p)*WH/2);
    rg=ctx.createRadialGradient(sx,sy,10,sx,sy,nb.rx*cam.zoom);
    rg.addColorStop(0,'rgba('+nb.col[0]+','+nb.col[1]+','+nb.col[2]+','+nb.alpha*1.8+')');
    rg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=rg; ctx.fillRect(0,0,W,H);
  }
  // dust
  for (i=0;i<dustClouds.length;i++) {
    var dc=dustClouds[i]; p=0.05;
    sx=wx(dc.x*p+(1-p)*WW/2); sy=wy(dc.y*p+(1-p)*WH/2);
    rg=ctx.createRadialGradient(sx,sy,5,sx,sy,dc.r*cam.zoom*2.5);
    var dcol=dc.warm?'rgba(120,80,30,'+dc.alpha+')':'rgba(30,60,120,'+dc.alpha+')';
    rg.addColorStop(0,dcol); rg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=rg; ctx.fillRect(0,0,W,H);
  }
  // stars
  var t=Date.now()/3000;
  for (i=0;i<starLayers.length;i++) {
    var layer=starLayers[i];
    for (var j=0;j<layer.stars.length;j++) {
      var s=layer.stars[j];
      var ox=-(cam.x-WW/2)*s.p, oy=-(cam.y-WH/2)*s.p;
      var fx=((s.x+ox)%W+W)%W, fy=((s.y+oy)%H+H)%H;
      var tw=0.5+0.5*Math.sin(s.tw+t);
      ctx.beginPath(); ctx.arc(fx,fy,s.r,0,Math.PI*2);
      ctx.fillStyle='rgba(200,210,255,'+(s.a*tw)+')';
      ctx.fill();
    }
  }
}

function drawWorldBorder() {
  ctx.save();
  ctx.strokeStyle='rgba(80,120,200,0.25)'; ctx.lineWidth=3*cam.zoom;
  ctx.setLineDash([20*cam.zoom,15*cam.zoom]);
  ctx.shadowColor='#4488ff'; ctx.shadowBlur=8;
  ctx.strokeRect(wx(0),wy(0),WW*cam.zoom,WH*cam.zoom);
  ctx.setLineDash([]);
  ctx.restore();
}

function drawParticles() {
  var i, p, a;
  for (i=0;i<particles.length;i++) {
    p=particles[i]; a=p.life/p.maxLife;
    ctx.save(); ctx.globalAlpha=a*0.88;
    ctx.beginPath(); ctx.arc(wx(p.x),wy(p.y),p.r*Math.max(0.05,a)*cam.zoom,0,Math.PI*2);
    ctx.fillStyle=p.color;
    if(p.color!=='#444444'){ctx.shadowColor=p.color;ctx.shadowBlur=5;}
    ctx.fill(); ctx.restore();
  }
}

function drawBullets() {
  var i, b;
  for (i=0;i<bullets.length;i++) {
    b=bullets[i];
    ctx.save();
    ctx.globalAlpha=b.isMine?(0.5+0.5*Math.sin(Date.now()/170)):b.life/b.maxLife;
    ctx.shadowColor=b.color; ctx.shadowBlur=b.isMine?24:12;
    ctx.beginPath(); ctx.arc(wx(b.x),wy(b.y),b.r*cam.zoom,0,Math.PI*2);
    ctx.fillStyle=b.color; ctx.fill();
    ctx.restore();
  }
}

function drawShip(ship) {
  if (!ship.alive()) return;
  ctx.save();
  ctx.globalAlpha=ship.alpha*(ship.hitFlash%2===1?0.2:1);
  ship.def.draw(ctx,wx(ship.x),wy(ship.y),ship.angle,ship.color,cam.zoom,ship.dmg());
  // laser
  if (ship.def.isLaser&&ship.laserTarget) {
    var t2=ship.laserTarget, pulse=0.5+0.5*Math.sin(Date.now()/32);
    ctx.globalAlpha=ship.alpha*pulse;
    ctx.beginPath(); ctx.moveTo(wx(ship.x),wy(ship.y)); ctx.lineTo(wx(t2.x),wy(t2.y));
    ctx.strokeStyle='rgba(255,68,0,0.33)'; ctx.lineWidth=(8+pulse*5)*cam.zoom; ctx.shadowColor='#ff6600'; ctx.shadowBlur=22; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(wx(ship.x),wy(ship.y)); ctx.lineTo(wx(t2.x),wy(t2.y));
    ctx.strokeStyle='#ff5500'; ctx.lineWidth=3*cam.zoom; ctx.shadowBlur=10; ctx.stroke();
    ctx.globalAlpha=ship.alpha;
  }
  // shield
  if (ship.shieldHp>0) {
    var sf=ship.shieldHp/60;
    ctx.globalAlpha=sf*0.55;
    var shr=ship.def.radius+12;
    var shg=ctx.createRadialGradient(wx(ship.x),wy(ship.y),shr*0.4*cam.zoom,wx(ship.x),wy(ship.y),(shr+5)*cam.zoom);
    shg.addColorStop(0,'rgba(0,0,0,0)'); shg.addColorStop(0.7,'rgba(68,136,255,0.2)'); shg.addColorStop(1,'rgba(136,187,255,0.8)');
    ctx.fillStyle=shg; ctx.beginPath(); ctx.arc(wx(ship.x),wy(ship.y),shr*cam.zoom,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#88bbff'; ctx.lineWidth=2*cam.zoom; ctx.shadowColor='#88bbff'; ctx.shadowBlur=16;
    ctx.beginPath(); ctx.arc(wx(ship.x),wy(ship.y),shr*cam.zoom,0,Math.PI*2); ctx.stroke();
  }
  // collide flash
  if (ship.collideFlash>0) {
    ctx.globalAlpha=(ship.collideFlash/10)*0.8;
    ctx.strokeStyle='#ffaa44'; ctx.lineWidth=2.5*cam.zoom; ctx.shadowColor='#ffaa44'; ctx.shadowBlur=14;
    ctx.beginPath(); ctx.arc(wx(ship.x),wy(ship.y),(ship.def.radius+8)*cam.zoom,0,Math.PI*2); ctx.stroke();
  }
  ctx.restore();
  if (ship.def.isLaser) ship.laserTarget=null;
}

function drawMinimap() {
  var mw=110, mh=110;
  var mx = Math.floor(W/2 - mw/2);
  var my = 72; // below the timer HUD row
  ctx.save();
  ctx.fillStyle='rgba(0,5,20,0.7)'; ctx.fillRect(mx,my,mw,mh);
  ctx.strokeStyle='rgba(60,100,180,0.4)'; ctx.lineWidth=1; ctx.strokeRect(mx,my,mw,mh);
  var i;
  ctx.fillStyle='#665544';
  for (i=0;i<asteroids.length;i++) {
    var ast=asteroids[i];
    ctx.beginPath(); ctx.arc(mx+ast.x/WW*mw,my+ast.y/WH*mh,Math.max(1,ast.size/30),0,Math.PI*2); ctx.fill();
  }
  ctx.fillStyle='#aaddff';
  for (i=0;i<comets.length;i++) {
    ctx.beginPath(); ctx.arc(mx+comets[i].x/WW*mw,my+comets[i].y/WH*mh,2,0,Math.PI*2); ctx.fill();
  }
  if (game) {
    for (i=0;i<game.p.length;i++) {
      var s=game.p[i]; if(!s.alive()) continue;
      ctx.fillStyle=s.color; ctx.shadowColor=s.color; ctx.shadowBlur=4;
      ctx.beginPath(); ctx.arc(mx+s.x/WW*mw,my+s.y/WH*mh,3,0,Math.PI*2); ctx.fill();
    }
  }
  ctx.restore();
}

// ── MAIN LOOP ─────────────────────────────────────
function loop() {
  W=canvas.width; H=canvas.height;
  ctx.clearRect(0,0,W,H);
  drawBackground();
  if (game) {
    updateCamera();
    drawWorldBorder();
    var i;
    for(i=0;i<asteroids.length;i++) asteroids[i].draw();
    for(i=0;i<comets.length;i++) comets[i].draw();
    for(i=0;i<debris.length;i++) debris[i].draw();
    drawParticles();
    drawBullets();
    if (!game.over) {
      for(i=0;i<game.p.length;i++) updateShip(game.p[i],i);
      checkShipCollision();
      updateBullets();
      updateParticles();
      updateWorld();
      for(i=0;i<game.p.length;i++) drawShip(game.p[i]);
      updateHUD();
      checkWin();
    } else {
      for(i=0;i<game.p.length;i++) drawShip(game.p[i]);
      updateParticles();
      for(i=0;i<debris.length;i++) debris[i].update();
    }
    drawMinimap();
  }
  requestAnimationFrame(loop);
}

// ── SCREENS ───────────────────────────────────────
document.getElementById('start-btn').addEventListener('click', function() {
  SFX.start();
  // Remove focus from button so it doesn't intercept Space/Enter
  if (document.activeElement) document.activeElement.blur();
  document.getElementById('sel-sc').classList.add('h');
  document.getElementById('kref').classList.add('vis');
  // auto-hide keyboard panel after 6s
  setTimeout(function(){ document.getElementById('kref').classList.remove('vis'); }, 6000);
  initGame();
  document.getElementById('timer').textContent=GAME_TIME;
  timerInt=setInterval(function(){
    if(!game||game.over)return;
    game.time--;
    document.getElementById('timer').textContent=game.time;
    if(game.time<=0) checkWin();
  },1000);
});
document.getElementById('rematch-btn').addEventListener('click', function() {
  document.getElementById('win-sc').classList.add('h');
  document.getElementById('sel-sc').classList.remove('h');
  document.getElementById('kref').classList.remove('vis');
});

resize();
loop();
</script>
</body>
</html>
